<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.samse.handichecker.mapper.GameRoomMapper">

    <!-- ResultMap 정의 -->
    <resultMap id="memberResultMap" type="com.samse.handichecker.entity.GameRoom">
        <id property="roomId" column="room_id"/>
        <result property="roomname" column="room_name"/>
        <result property="gamerule" column="game_rule" typeHandler="org.apache.ibatis.type.EnumTypeHandler"/>
        <result property="handiYn" column="handi_yn"/>
        <result property="handiRatio" column="handi_rate"/>
        <result property="maxParticipants" column="max_participants"/>
        <result property="currentParticipants" column="current_participants"/>
        <result property="gameLocation" column="game_location"/>
        <result property="createdBy" column="created_by"/>
        <result property="roomStatus" column="room_status"/>
        <result property="createdAt" column="created_at"/>
        <result property="startedAt" column="started_at"/>
        <result property="finishedAt" column="finished_at"/>
    </resultMap>
    
    <resultMap id="participantResultMap" type="com.samse.handichecker.entity.GameParticipant">
    	<id property="participantId" column="participant_id" />
    	<result property="roomId" column="room_id" />
    	<result property="memberId" column="member_id" />
    	<result property="joinOrder" column="join_order" />
    	<result property="readyYn" column="ready_yn" />
    	<result property="joined_at" column="joined_at" />
    	<result property="left_at" column="left_at" />
    </resultMap>

    <!-- 전체 방목록 조회 -->
    <select id="selectAllGameRooms" resultMap="memberResultMap">
        SELECT 
            room_name, game_rule, handi_yn, handi_ratio, 
            max_participants, current_participants,
            game_location, room_status, created_by, 
            created_at, started_at, finished_at 
        FROM game_rooms
        ORDER BY created_at DESC
    </select>
	<!-- 게임방 생성 -->
	<insert id="insertGameRoom" parameterType="com.samse.handichecker.entity.GameRoom"
		useGeneratedKeys="true"
		keyProperty="roomId"
		keyColumn="room_id"
	>
		INSERT INTO game_rooms (
			room_name, game_rule, max_participants,
			game_location, handi_yn, handi_ratio, created_by
		 ) 
		VALUES (#{roomName}, #{gameRule}, #{maxParticipants},
			#{gameLocation}, #{handiYn}, #{handiRatio}, #{createdBy});
	</insert>
	<!-- 게임방 수정 -->
	<update id="updateGameRoom" parameterType="com.samse.handichecker.entity.GameRoom">
		UPDATE game_rooms
		SET room_name = #{room_name}, game_rule = #{game_rule}, game_location = #{game_location},
			handi_yn = #{handi_yn}, handi_ratio=#{handi_ratio} 
		WHERE room_id = #{room_id}
	</update>
	<!-- 게임방 참여 -->
	<insert id="joinGameRoom" parameterType="com.samse.handichecker.entity.GameParticipant">
		INSERT INTO room_participants
			(room_id, member_id)
		VALUES (#{roomId}, #{memberId})
	</insert>
	<!-- 게임방에 이미 참여했는지 여부 -->
	<select id="isJoinedGameRoom" parameterType="com.samse.handichecker.entity.GameParticipant">
		SELECT COUNT(*) 
		FROM room_participants
		WHERE member_id = #{memberId} AND room_id = #{roomId} AND left_at is null
	</select>

</mapper>